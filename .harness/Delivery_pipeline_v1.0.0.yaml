template:
  name: Delivery pipeline
  type: Pipeline
  projectIdentifier: grand_line
  orgIdentifier: default
  spec:
    stages:
      - stage:
          name: Deploy To Development
          identifier: Deploy_To_Development
          description: ""
          type: Deployment
          spec:
            deploymentType: NativeHelm
            service:
              serviceRef: <+input>
              serviceInputs: <+input>
              disableArtifactValidation: true
            environment:
              environmentRef: <+input>
              deployToAll: false
              environmentInputs: <+input>
              serviceOverrideInputs: <+input>
              infrastructureDefinitions: <+input>
            execution:
              steps:
                - step:
                    type: ShellScript
                    name: Verify Signature - Cosign DEV
                    identifier: Verify_Signature_Cosign
                    spec:
                      shell: Bash
                      executionTarget: {}
                      source:
                        type: Inline
                        spec:
                          script: set -e
                      environmentVariables: []
                      outputVariables: []
                    timeout: 10m
                  contextType: Pipeline
                - step:
                    name: Helm Deployment
                    identifier: helmDeployment
                    type: HelmDeploy
                    timeout: 10m
                    spec:
                      skipDryRun: false
                      ignoreReleaseHistFailStatus: false
              rollbackSteps:
                - step:
                    name: Helm Rollback
                    identifier: helmRollback
                    type: HelmRollback
                    timeout: 10m
                    spec: {}
          tags: {}
          failureStrategies:
            - onFailure:
                errors:
                  - AllErrors
                action:
                  type: StageRollback
      - stage:
          name: OWASP ZAP
          identifier: OWASP_ZAP
          description: ""
          type: CI
          spec:
            cloneCodebase: false
            caching:
              enabled: true
              override: true
            buildIntelligence:
              enabled: true
            platform:
              os: Linux
              arch: Amd64
            runtime:
              type: Cloud
              spec: {}
            execution:
              steps:
                - step:
                    type: Zap
                    name: OWASP ZAP
                    identifier: OWASP_ZAP
                    spec:
                      mode: orchestration
                      config: default
                      target:
                        type: instance
                        detection: auto
                      advanced:
                        log:
                          level: info
                      instance:
                        domain: https://tamekia-uneternized-alease.ngrok-free.dev
                        protocol: https
                        path: v1/version
                    when:
                      stageStatus: Success
                      condition: <+pipeline.variables.FEATURE_FLAG_EXECUTION> != "0"
          when:
            pipelineStatus: Success
            condition: <+pipeline.variables.FEATURE_FLAG_EXECUTION> != "0"
      - stage:
          name: Approval Gate - Staging
          identifier: Approval_Gate_Staging
          description: ""
          type: Approval
          spec:
            execution:
              steps:
                - step:
                    name: Approval - QA
                    identifier: Approval_QA
                    type: HarnessApproval
                    timeout: 1d
                    spec:
                      approvalMessage: |-
                        Please review the following information
                        and approve the pipeline progression
                      includePipelineExecutionHistory: true
                      approvers:
                        minimumCount: 1
                        disallowPipelineExecutor: false
                        userGroups:
                          - account._account_all_users
                      isAutoRejectEnabled: false
                      approverInputs: []
          tags: {}
      - stage:
          name: Deploy To Staging
          identifier: Deploy_To_Staging
          description: ""
          type: Deployment
          spec:
            deploymentType: NativeHelm
            service:
              serviceRef: <+input>
              serviceInputs: <+input>
            environment:
              environmentRef: <+input>
              deployToAll: false
              environmentInputs: <+input>
              serviceOverrideInputs: <+input>
              infrastructureDefinitions: <+input>
            execution:
              steps:
                - step:
                    type: ShellScript
                    name: Verify Signature - Cosign STG
                    identifier: Verify_Signature_Cosign_STG
                    spec:
                      shell: Bash
                      executionTarget: {}
                      source:
                        type: Inline
                        spec:
                          script: set -e
                      environmentVariables: []
                      outputVariables: []
                    timeout: 10m
                - step:
                    name: Helm Deployment
                    identifier: helmDeployment
                    type: HelmDeploy
                    timeout: 10m
                    spec:
                      skipDryRun: false
              rollbackSteps:
                - step:
                    name: Helm Rollback
                    identifier: helmRollback
                    type: HelmRollback
                    timeout: 10m
                    spec: {}
          tags: {}
          failureStrategies:
            - onFailure:
                errors:
                  - AllErrors
                action:
                  type: StageRollback
      - stage:
          name: Approval Gate - Production
          identifier: Approval_Gate_Production
          description: ""
          type: Approval
          spec:
            execution:
              steps:
                - step:
                    name: Approval - Stackholders
                    identifier: Approval_Stackholders
                    type: HarnessApproval
                    timeout: 1d
                    spec:
                      approvalMessage: |-
                        Please review the following information
                        and approve the pipeline progression
                      includePipelineExecutionHistory: true
                      approvers:
                        minimumCount: 1
                        disallowPipelineExecutor: false
                        userGroups:
                          - account._account_all_users
                      isAutoRejectEnabled: false
                      approverInputs: []
          tags: {}
      - stage:
          name: Deploy to Production
          identifier: Deploy_to_Production
          description: ""
          type: Deployment
          spec:
            deploymentType: NativeHelm
            service:
              serviceRef: <+input>
              serviceInputs: <+input>
            environment:
              environmentRef: <+input>
              deployToAll: false
              environmentInputs: <+input>
              serviceOverrideInputs: <+input>
              infrastructureDefinitions: <+input>
            execution:
              steps:
                - step:
                    type: ShellScript
                    name: Verify Signature - Cosign PROD
                    identifier: Verify_Signature_Cosign_PROD
                    spec:
                      shell: Bash
                      executionTarget: {}
                      source:
                        type: Inline
                        spec:
                          script: set -e
                      environmentVariables: []
                      outputVariables: []
                    timeout: 10m
                - step:
                    type: HelmDeploy
                    name: Helm Deployment
                    identifier: Helm_Deployment
                    spec:
                      skipDryRun: false
                      ignoreReleaseHistFailStatus: false
                    timeout: 10m
              rollbackSteps:
                - step:
                    name: Helm Rollback
                    identifier: helmRollback
                    type: HelmRollback
                    timeout: 10m
                    spec: {}
          tags: {}
          failureStrategies:
            - onFailure:
                errors:
                  - AllErrors
                action:
                  type: StageRollback
          when:
            pipelineStatus: Success
            condition: <+pipeline.variables.DEPLOYMENT_STRATEGY> == "rolling"
      - stage:
          name: Deploy to Production - Canary
          identifier: Deploy_to_Production_Canary
          description: ""
          type: Deployment
          spec:
            deploymentType: Kubernetes
            service:
              serviceRef: <+input>
              serviceInputs: <+input>
            environment:
              environmentRef: <+input>
              deployToAll: false
              environmentInputs: <+input>
              serviceOverrideInputs: <+input>
              infrastructureDefinitions: <+input>
            execution:
              steps:
                - stepGroup:
                    name: Canary Deployment
                    identifier: canaryDeployment
                    steps:
                      - step:
                          name: Canary Deployment -  25
                          identifier: Canary_Deployment_25
                          type: K8sCanaryDeploy
                          timeout: 10m
                          spec:
                            instanceSelection:
                              spec:
                                percentage: 25
                              type: Percentage
                            skipDryRun: false
                            delegateSelectors:
                              - helm-delegate
                      - step:
                          type: HarnessApproval
                          name: Deploy Approval
                          identifier: Deploy_Approval
                          spec:
                            approvalMessage: Please review the following information and approve the pipeline progression
                            includePipelineExecutionHistory: true
                            isAutoRejectEnabled: false
                            approvers:
                              userGroups:
                                - account._account_all_users
                              minimumCount: 1
                              disallowPipelineExecutor: false
                            approverInputs: []
                          timeout: 1d
                      - step:
                          type: K8sCanaryDeploy
                          name: Canary Deployment - 50
                          identifier: Canary_Deployment_50
                          spec:
                            skipDryRun: false
                            instanceSelection:
                              spec:
                                percentage: 50
                              type: Percentage
                          timeout: 10m
                      - step:
                          type: Http
                          name: Check Reachability
                          identifier: Check_Reachability
                          spec:
                            url: https://tamekia-uneternized-alease.ngrok-free.dev/v1/version
                            method: GET
                            headers: []
                            inputVariables: []
                            outputVariables: []
                          timeout: 10s
                          strategy:
                            repeat:
                              times: 5
                - stepGroup:
                    name: Primary Deployment
                    identifier: primaryDeployment
                    steps:
                      - step:
                          type: HarnessApproval
                          name: Should Rollout
                          identifier: Should_Rollout
                          spec:
                            approvalMessage: Please review the following information and approve the pipeline progression
                            includePipelineExecutionHistory: true
                            isAutoRejectEnabled: false
                            approvers:
                              userGroups:
                                - account._account_all_users
                              minimumCount: 1
                              disallowPipelineExecutor: false
                            approverInputs: []
                          timeout: 1d
                      - step:
                          name: Rolling Deployment
                          identifier: rollingDeployment
                          type: K8sRollingDeploy
                          timeout: 10m
                          spec:
                            skipDryRun: false
                - stepGroup:
                    name: Canary Group Delete
                    identifier: Canary_Group_Delete
                    steps:
                      - step:
                          type: HarnessApproval
                          name: Freeze
                          identifier: Freeze
                          spec:
                            approvalMessage: Please review the following information and approve the pipeline progression
                            includePipelineExecutionHistory: true
                            isAutoRejectEnabled: false
                            approvers:
                              userGroups:
                                - account._account_all_users
                              minimumCount: 1
                              disallowPipelineExecutor: false
                            approverInputs: []
                          timeout: 1d
                      - step:
                          name: Canary Delete
                          identifier: canaryDelete
                          type: K8sCanaryDelete
                          timeout: 10m
                          spec: {}
                      - step:
                          type: Http
                          name: "Check "
                          identifier: Check
                          spec:
                            url: https://tamekia-uneternized-alease.ngrok-free.dev/v1/version
                            method: GET
                            headers: []
                            inputVariables: []
                            outputVariables: []
                            requestBody: ""
                          timeout: 10s
                          strategy:
                            repeat:
                              times: 5
              rollbackSteps:
                - step:
                    name: Canary Delete
                    identifier: rollbackCanaryDelete
                    type: K8sCanaryDelete
                    timeout: 10m
                    spec: {}
                - step:
                    name: Rolling Rollback
                    identifier: rollingRollback
                    type: K8sRollingRollback
                    timeout: 10m
                    spec: {}
          tags: {}
          failureStrategies:
            - onFailure:
                errors:
                  - AllErrors
                action:
                  type: StageRollback
          when:
            pipelineStatus: Success
            condition: <+pipeline.variables.DEPLOYMENT_STRATEGY> == "canary"
      - stage:
          name: Deploy to Production - Blue Green
          identifier: Deploy_to_Production_Blue_Green
          description: ""
          type: Deployment
          spec:
            deploymentType: Kubernetes
            service:
              serviceRef: <+input>
              serviceInputs: <+input>
            environment:
              environmentRef: <+input>
              deployToAll: false
              environmentInputs: <+input>
              serviceOverrideInputs: <+input>
              infrastructureDefinitions: <+input>
            execution:
              steps:
                - step:
                    name: Stage Deployment
                    identifier: stageDeployment
                    type: K8sBlueGreenDeploy
                    timeout: 10m
                    spec:
                      skipDryRun: false
                      pruningEnabled: false
                - step:
                    name: Swap primary with stage service
                    identifier: bgSwapServices
                    type: K8sBGSwapServices
                    timeout: 10m
                    spec:
                      skipDryRun: false
              rollbackSteps:
                - step:
                    name: Swap primary with stage service
                    identifier: rollbackBgSwapServices
                    type: K8sBGSwapServices
                    timeout: 10m
                    spec:
                      skipDryRun: false
          tags: {}
          failureStrategies:
            - onFailure:
                errors:
                  - AllErrors
                action:
                  type: StageRollback
          when:
            pipelineStatus: Success
            condition: <+pipeline.variables.DEPLOYMENT_STRATEGY> == "bluegreen"
    variables:
      - name: FEATURE_FLAG_EXECUTION
        type: String
        description: ""
        required: false
        value: "0"
      - name: DEPLOYMENT_STRATEGY
        type: String
        description: ""
        required: true
        value: canary
  identifier: Delivery_pipeline
  versionLabel: v1.0.0
