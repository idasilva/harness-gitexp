template:
  name: Build Package S3 War Files
  identifier: Build_Package_S3_War_Files
  versionLabel: v1.0.0
  type: StepGroup
  projectIdentifier: grand_line
  orgIdentifier: default
  tags: {}
  spec:
    stageType: CI
    steps:
      - step:
          type: Run
          name: Build
          identifier: Build
          spec:
            connectorRef: <+input>
            image: docker.io/library/maven:3.9-eclipse-temurin-17
            shell: Sh
            command: |-
              cd <+stepGroup.variables.WORKSPACE>
              mvn clean package -q -DskipTests
              ls -la target/*.war
        contextType: StepGroupTemplate
      - step:
          type: Run
          name: Package
          identifier: Package
          spec:
            shell: Bash
            command: |-
              cd <+stepGroup.variables.WORKSPACE>
              TAR_NAME="<+stepGroup.variables.WAR_APPLICATION_ARTIFACTORY_NAME>-<+pipeline.sequenceId>.tar.gz"

              echo "Creating TAR package..."
              mkdir -p dist

              WAR_FILE=$(ls target/*.war | head -1)
              WAR_BASENAME=$(basename $WAR_FILE)

              tar -czvf dist/${TAR_NAME} \
                -C target ${WAR_BASENAME} \
                -C ../config .

              echo "TAR created:"
              ls -la dist/

              ARTIFACTORY_PATH="+stepGroup.variables.WAR_APPLICATION_ARTIFACTORY_NAME>/<+pipeline.sequenceId>/"

              mkdir -p /harness/${ARTIFACTORY_PATH}
              cp dist/${TAR_NAME} /harness/${ARTIFACTORY_PATH}/
        contextType: StepGroupTemplate
      - step:
          type: S3Upload
          name: S3Upload
          identifier: S3Upload_1
          spec:
            connectorRef: <+input>
            region: <+input>
            bucket: <+input>
            sourcePath: /harness/<+stepGroup.variables.WAR_APPLICATION_ARTIFACTORY_NAME>/<+pipeline.sequenceId>/*.tar.gz
        contextType: StepGroupTemplate
    variables:
      - name: WORKSPACE
        type: String
        value: <+input>
        description: ""
        required: true
      - name: WAR_APPLICATION_ARTIFACTORY_NAME
        type: String
        value: <+input>
        description: ""
        required: true
