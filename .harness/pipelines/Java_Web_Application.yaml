pipeline:
  name: Java Web Application
  identifier: Java_Web_Application
  projectIdentifier: grand_line
  orgIdentifier: default
  tags: {}
  stages:
    - stage:
        name: Build
        identifier: Build
        description: ""
        type: CI
        spec:
          cloneCodebase: true
          caching:
            enabled: true
            override: true
          buildIntelligence:
            enabled: true
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
          execution:
            steps:
              - stepGroup:
                  name: Build Package Upload War Files
                  identifier: Build_Package_Upload_War_Files
                  template:
                    templateRef: Build_Package_S3_War_Files
                    versionLabel: v1.0.0
                    gitBranch: main
                    templateInputs:
                      steps:
                        - stepGroup:
                            identifier: Build_Package_Artifact
                            steps:
                              - step:
                                  identifier: Build
                                  type: Run
                                  spec:
                                    connectorRef: <+input>
                                    envVariables:
                                      WORKSPACE: <+input>
                              - step:
                                  identifier: S3Upload_1
                                  type: S3Upload
                                  spec:
                                    connectorRef: <+input>
                                    region: <+input>
                                    bucket: <+input>
                                    target: <+input>
              - step:
                  type: Run
                  name: Build
                  identifier: Build
                  spec:
                    connectorRef: docker_connector_lab
                    image: docker.io/library/maven:3.9-eclipse-temurin-17
                    shell: Bash
                    command: |-
                      cd /harness/services/merry
                      echo "→ Building WAR..."
                      mvn clean package -q -DskipTests
                      echo "→ WAR created:"
                      ls -la target/*.war
              - step:
                  type: Run
                  name: Package
                  identifier: Package
                  spec:
                    shell: Bash
                    command: |-
                      cd /harness/services/merry

                      APP_NAME="merry"
                      VERSION="1.0.<+pipeline.sequenceId>"
                      TAR_NAME="${APP_NAME}-v${VERSION}.tar.gz"

                      mkdir -p dist

                      echo "→ Creating TAR package..."

                      # First, find the actual WAR filename
                      WAR_FILE=$(ls target/*.war | head -1)
                      WAR_BASENAME=$(basename $WAR_FILE)

                      echo "→ Found WAR: $WAR_BASENAME"

                      # Create TAR with correct paths
                      tar -czvf dist/${TAR_NAME} \
                        -C target ${WAR_BASENAME} \
                        -C ../config .

                      echo "→ TAR created:"
                      ls -la dist/

                      echo "TAR_PATH=/harness/services/merry/dist/${TAR_NAME}" >> $HARNESS_OUTPUT_FILE
              - step:
                  type: S3Upload
                  name: S3Upload_1
                  identifier: S3Upload_1
                  spec:
                    connectorRef: aws_s3_connector
                    region: us-east-1
                    bucket: bes-innovation-artifact
                    sourcePath: /harness/services/merry/dist/*.tar.gz
                    target: merry
    - stage:
        name: Deploy War
        identifier: Deploy_War
        description: ""
        type: Deployment
        spec:
          deploymentType: Ssh
          service:
            serviceRef: War_Deploy
          environment:
            environmentRef: Development
            deployToAll: false
            infrastructureDefinitions:
              - identifier: Deploy_To_EC2
          execution:
            steps:
              - step:
                  type: Command
                  name: Download Artifact
                  identifier: Download_Artifact
                  spec:
                    onDelegate: false
                    environmentVariables: []
                    outputVariables: []
                    commandUnits:
                      - identifier: Download
                        name: Download
                        type: Script
                        spec:
                          shell: Bash
                          source:
                            type: Inline
                            spec:
                              script: |-
                                set -e

                                echo "→ Creating deploy directory..."
                                mkdir -p /tmp/deploy
                                cd /tmp/deploy

                                echo "→ Downloading artifact from S3..."
                                aws s3 cp s3://bes-innovation-artifact/merry/harness/services/merry/dist/merry-v1.0.10.tar.gz .

                                echo "→ Extracting TAR..."
                                tar -xzf merry-v1.0.10.tar.gz

                                echo "→ Artifact contents:"
                                ls -la /tmp/deploy/

                                echo "✅ Download complete!"
                    delegateSelectors:
                      - linux-amd64
                  timeout: 10m
                  strategy:
                    repeat:
                      items: <+stage.output.hosts>
              - step:
                  type: Command
                  name: Deploy Artifact
                  identifier: Deploy_Artifact
                  spec:
                    onDelegate: false
                    environmentVariables: []
                    outputVariables: []
                    commandUnits:
                      - identifier: Deploy_Artifact
                        name: Deploy Artifact
                        type: Script
                        spec:
                          shell: Bash
                          source:
                            type: Inline
                            spec:
                              script: |-
                                set -e

                                cd /tmp/deploy

                                echo "→ Stopping Tomcat..."
                                sudo systemctl stop tomcat

                                echo "→ Backing up old WAR..."
                                sudo mv /opt/tomcat/webapps/merry.war /opt/tomcat/webapps/merry.war.bak 2>/dev/null || true
                                sudo rm -rf /opt/tomcat/webapps/merry 2>/dev/null || true

                                echo "→ Deploying new WAR..."
                                sudo cp *.war /opt/tomcat/webapps/merry.war
                                sudo chown tomcat:tomcat /opt/tomcat/webapps/merry.war

                                echo "→ Starting Tomcat..."
                                sudo systemctl start tomcat

                                echo "✅ Deploy complete!"
                  timeout: 10m
                  strategy:
                    repeat:
                      items: <+stage.output.hosts>
            rollbackSteps:
              - step:
                  name: Rollback
                  identifier: Deploy
                  timeout: 10m
                  strategy:
                    repeat:
                      items: <+stage.output.hosts>
                  template:
                    templateRef: account.Default_Install_War_Bash
                    templateInputs:
                      type: Command
                      spec:
                        environmentVariables:
                          - name: DestinationDirectory
                            type: String
                            value: $HOME/<+service.name>/<+env.name>
        tags: {}
        failureStrategies:
          - onFailure:
              errors:
                - AllErrors
              action:
                type: StageRollback
  properties:
    ci:
      codebase:
        connectorRef: gh_connector
        repoName: harness
        build: <+input>
